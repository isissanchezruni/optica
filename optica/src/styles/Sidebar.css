.sidebar {
  width: 240px;
  background: linear-gradient(180deg, #e3f2fd, #bbdefb);
  color: #0d47a1;
  height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  position: fixed;
  top: 0;
  left: 0;
  box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
  padding: 20px 0;
}

.sidebar-header {
  text-align: center;
  padding: 10px 0;
  border-bottom: 1px solid rgba(13, 71, 161, 0.2);
}

.sidebar-header h2 {
  font-size: 1.2rem;
  color: #0d47a1;
  margin: 0;
}

.sidebar-menu {
  list-style: none;
  padding: 0;
  margin-top: 20px;
  flex: 1;
}

.sidebar-menu li {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  cursor: pointer;
  transition: background 0.3s, color 0.3s;
  font-weight: 500;
}

.sidebar-menu li:hover {
  background-color: #90caf9;
  color: #0d47a1;
}

.sidebar-menu .icon {
  font-size: 1.2rem;
}

.sidebar-footer {
  padding: 15px 20px;
  border-top: 1px solid rgba(13, 71, 161, 0.2);
}

.logout-btn {
  background-color: #0d47a1;
  color: white;
  border: none;
  padding: 10px 15px;
  width: 100%;
  border-radius: 6px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: background 0.3s;
}

.logout-btn:hover {
  background-color: #1565c0;
}

.sidebar-link {
  display: flex;
  align-items: center;
  gap: 10px;
  color: #1a237e;
  text-decoration: none;
  padding: 10px 15px;
  border-radius: 8px;
  transition: background 0.2s;
}

.sidebar-link:hover {
  background-color: #e3f2fd;
  color: #0d47a1;
}

@media (max-width: 768px) {
  .sidebar {
    width: 200px;
    position: absolute;
    z-index: 1000;
  }

  .layout-content {
    margin-left: 0;
  }
}
-- =========================
-- 1. EXTENSIONES Y LIMPIEZA
-- =========================
create extension if not exists "uuid-ossp";
create extension if not exists "pgcrypto";

-- =========================
-- 2. TABLA DE PERFILES
-- =========================
create table if not exists public.profiles (
  id uuid references auth.users on delete cascade primary key,
  full_name text,
  phone text,
  role text not null default 'patient',
  created_at timestamptz default now()
);

ALTER TABLE public.profiles
ADD COLUMN email text;

alter table public.profiles disable row level security;

-- ================
-- 3. TABLA PACIENTES
-- (Opcional, pero útil si se necesitan campos extra)
-- ================
create table if not exists public.patients (
  id uuid references profiles(id) on delete cascade primary key,
  birthdate date,
  address text
);

alter table public.patients enable row level security;

-- ===================
-- 4. TABLA DE EXÁMENES
-- ===================
create table if not exists public.exams (
  id uuid primary key default gen_random_uuid(),
  patient_id uuid references profiles(id) not null,
  scheduled_at timestamptz,
  performed boolean default false,
  storage_path text, -- ruta del archivo en Supabase Storage
  observations text,
  diagnosis text,
  specialist_role text check (specialist_role in ('ortoptist', 'optometrist')),
  created_by uuid references profiles(id),
  created_at timestamptz default now()
);

alter table public.exams enable row level security;

-- ====================
-- 5. TABLA DE REMISIONES
-- ====================
create table if not exists public.referrals (
  id uuid primary key default gen_random_uuid(),
  patient_id uuid references profiles(id) not null,
  from_role text check (from_role in ('ortoptist', 'optometrist')),
  to_role text check (to_role in ('ortoptist', 'optometrist')),
  reason text,
  created_by uuid references profiles(id),
  created_at timestamptz default now()
);

alter table public.referrals enable row level security;

-- ====================
-- 6. TABLA DE CITAS
-- ====================
create table if not exists public.appointments (
  id uuid primary key default gen_random_uuid(),
  patient_id uuid references profiles(id) not null,
  specialist_role text check (specialist_role in ('ortoptist', 'optometrist')),
  specialist_id uuid references profiles(id),
  scheduled_at timestamptz not null,
  status text default 'scheduled' check (status in ('scheduled','done','canceled')),
  created_by uuid references profiles(id),
  created_at timestamptz default now()
);

alter table public.appointments enable row level security;

-- ====================
-- 7. TABLA DE PUNTAJES (JUEGOS)
-- ====================
create table if not exists public.game_scores (
  id uuid primary key default gen_random_uuid(),
  user_id uuid references profiles(id),
  game text check (game in ('follow_dot','find_different')),
  level int check (level between 1 and 3),
  score int,
  created_at timestamptz default now()
);

alter table public.game_scores enable row level security;

-- ===========================================================
-- 8. POLÍTICAS RLS (Row Level Security)
-- ===========================================================

-- ---------- PROFILES ----------
-- Cada usuario solo ve y edita su propio perfil
create policy "Usuarios pueden ver su propio perfil"
on profiles for select
using (auth.uid() = id);

-- Permitir que usuarios autenticados inserten su propio profile (al registrarse)
create policy "auth users can insert own profile" on public.profiles
for insert
with check (auth.uid() = id);

create policy "allow select own profile"
on public.profiles
for select
using (auth.uid() = id);

create policy "allow insert own profile" 
on public.profiles
for insert
with check (auth.uid() = id);

create policy "Usuarios pueden editar su propio perfil"
on profiles for update
using (auth.uid() = id)
with check (auth.uid() = id);

-- Admins y especialistas pueden ver todos
create policy "Admin y especialistas pueden ver todos los perfiles"
on profiles for select
using (
  exists (
    select 1 from profiles p
    where p.id = auth.uid()
    and p.role in ('admin', 'optometrist', 'ortoptist')
  )
);

-- Solo admin puede editar cualquier perfil
create policy "Solo admin puede editar todos"
on profiles for update
using (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role = 'admin'
  )
);

-- ---------- PATIENTS ----------
-- Cada paciente puede ver su propio registro
create policy "Pacientes pueden ver su propio registro"
on patients for select
using (auth.uid() = id);

-- Especialistas y admin pueden ver y editar todos
create policy "Especialistas y admin pueden ver/editar todos los pacientes"
on patients
for all
using (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role in ('admin','optometrist','ortoptist')
  )
)
with check (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role in ('admin','optometrist','ortoptist')
  )
);

-- ---------- EXAMS ----------
-- Pacientes: solo pueden ver sus propios exámenes
create policy "Paciente puede ver sus propios exámenes"
on exams for select
using (auth.uid() = patient_id);

-- Especialistas y admin: pueden ver todos los exámenes
create policy "Especialistas y admin pueden ver todos los exámenes"
on exams for select
using (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role in ('admin','optometrist','ortoptist')
  )
);

-- Especialistas pueden crear nuevos exámenes
create policy "Especialistas pueden crear exámenes"
on exams for insert
with check (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role in ('optometrist','ortoptist','admin')
  )
);

-- Especialistas pueden actualizar exámenes que ellos crearon o que correspondan a su rol
create policy "Especialistas pueden actualizar sus exámenes"
on exams for update
using (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and (p.role = exams.specialist_role or p.role = 'admin')
  )
)
with check (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and (p.role = exams.specialist_role or p.role = 'admin')
  )
);

-- Solo admin puede eliminar exámenes
create policy "Solo admin puede eliminar exámenes"
on exams for delete
using (
  exists (
    select 1 from profiles p where p.id = auth.uid() and p.role = 'admin'
  )
);

-- ---------- REFERRALS ----------
-- Pacientes: pueden ver sus propias remisiones
create policy "Pacientes pueden ver sus remisiones"
on referrals for select
using (auth.uid() = patient_id);

-- Especialistas y admin: ver todos, crear nuevas
create policy "Especialistas y admin ver/crear remisiones"
on referrals
for all
using (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role in ('optometrist','ortoptist','admin')
  )
)
with check (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role in ('optometrist','ortoptist','admin')
  )
);

-- ---------- APPOINTMENTS ----------
-- Pacientes: pueden ver sus propias citas
create policy "Pacientes pueden ver sus citas"
on appointments for select
using (auth.uid() = patient_id);

-- Especialistas y admin: ver todas y crear/editar
create policy "Especialistas y admin pueden ver/crear/editar citas"
on appointments
for all
using (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role in ('optometrist','ortoptist','admin')
  )
)
with check (
  exists (
    select 1 from profiles p
    where p.id = auth.uid() and p.role in ('optometrist','ortoptist','admin')
  )
);

-- ---------- GAME_SCORES ----------
-- Cada usuario puede ver solo sus puntajes
create policy "Usuarios pueden ver sus puntajes"
on game_scores for select
using (auth.uid() = user_id);

-- Los usuarios pueden insertar sus propios puntajes
create policy "Usuarios pueden insertar sus puntajes"
on game_scores for insert
with check (auth.uid() = user_id);

-- Admin puede ver todos
create policy "Admin puede ver todos los puntajes"
on game_scores for select
using (
  exists (
    select 1 from profiles p where p.id = auth.uid() and p.role = 'admin'
  )
);

-- =============================
-- 9. INSERTAR ROLES DE PRUEBA (Opcional)
-- =============================
-- Solo para pruebas: crear usuarios ficticios (borralos luego)
-- Ejecuta esto solo si quieres testear sin registro real
/*
insert into profiles (id, full_name, role)
values
  (gen_random_uuid(), 'Admin Demo', 'admin'),
  (gen_random_uuid(), 'Dr. Ortoptista', 'ortoptist'),
  (gen_random_uuid(), 'Dr. Optometrista', 'optometrist');
*/

-- =============================
-- 10. VERIFICAR
-- =============================
-- Puedes verificar con:
-- select * from profiles;
-- select * from exams;
-- select * from referrals;
-- select * from appointments;
